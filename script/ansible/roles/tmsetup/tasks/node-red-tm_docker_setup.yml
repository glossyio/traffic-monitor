---
# TMSetup - Node-RED-TM Setup tasks

- name: TMSetup - Node-RED-TM Setup - Check for radars
  loop: "{{ tmsetup_radar_paths }}"
  ansible.builtin.stat:
    path: "{{ item }}"
  register: tmsetup_radarpath_stat_register

- name: TMSetup Node-RED-TM Setup - Add existing radars to list
  loop: "{{ tmsetup_radarpath_stat_register.results }}"
  when: item['stat']['exists'] | bool
  ansible.builtin.set_fact:
    tmsetup_radars_confirmed: "{{ tmsetup_radars_confirmed | default([]) + [item['stat']['path']] }}"

# https://github.com/node-red/node-red-docker/wiki/Permissions-and-Persistence
- name: TMSetup - Node-RED-TM Setup - Create Node-RED-TM Data Persistence Directories and Set Ownership
  become: true
  loop:
    - '{{ tmsetup_codedir }}/node-red-tm'
    - '{{ tmsetup_codedir }}/node-red-tm/config'
    - '{{ tmsetup_codedir }}/node-red-tm/data'
    - '{{ tmsetup_codedir }}/node-red-tm/db'
  block:
    - name: Create directory and set ownership
      ansible.builtin.file:
        path: '{{ item }}'
        state: directory
        owner: '{{ tmsetup_codeowner }}'
        group: '{{ tmsetup_codegroup }}'
        mode: '0755'
      notify: Restart tm-docker service

    - name: Set node-red owner and group
      ansible.builtin.command: chown -R 1000:1000 {{ item }}
      notify: Restart tm-docker service

- name: TMSetup - Node Red Setup - Copy relevant static files for node red deployment
  become: true
  loop:
    - flows_cred.json
    - flows.json
    - package.json
    - README.md
    - settings.js
  block:
    - name: Set ownership
      ansible.builtin.copy:
        dest: '{{ tmsetup_codedir }}/node-red-tm/data/{{ item }}'
        group: '{{ tmsetup_codegroup }}'
        mode: '0755'
        owner: '{{ tmsetup_codeowner }}'
        src: 'node-red-tm/{{ item }}'
    - name: Set node-red owner and group
      ansible.builtin.command: chown -R 1000:1000 {{ item }}
      notify: Restart tm-docker service

- name: TMSetup - Node-RED-TM Setup - Create Node-RED-TM Dockerfile
  become: true
  loop:
    - node-red-tm/Dockerfile
    - node-red-tm/docker-compose-node-red-tm.yaml
  ansible.builtin.template:
    backup: true
    dest: '{{ tmsetup_codedir }}/{{ item }}'
    force: true
    group: '{{ tmsetup_codegroup }}'
    mode: '0640'
    owner: '{{ tmsetup_codeowner }}'
    src: '{{ item }}.j2'
  notify:
    - Build container images
    - Restart tm-docker service

- name: TMSetup - Node-RED-TM Setup - Create Node-RED-TM docker files
  become: true
  loop:
    - node-red-tm/config/config.yml
    - node-red-tm/node-red-tm.env
  ansible.builtin.template:
    backup: true
    dest: '{{ tmsetup_codedir }}/{{ item }}'
    force: '{{ tmsetup_force_configs }}'
    group: '{{ tmsetup_codegroup }}'
    mode: '0640'
    owner: '{{ tmsetup_codeowner }}'
    src: '{{ item }}.j2'
  notify: Restart tm-docker service
...
